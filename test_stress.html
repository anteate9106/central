<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스트레스 검사 - 청년들 성격유형 검사 시스템</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 스트레스 검사 전용 스타일 */
        .test-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 40px;
        }

        .test-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .test-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .question-number {
            background: #ff6b6b;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .answer-scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .scale-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .scale-option:hover {
            background: #e9ecef;
        }

        .scale-option.selected {
            background: #ff6b6b;
            color: white;
        }

        .scale-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .scale-label {
            font-size: 0.9rem;
            text-align: center;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-outline:hover {
            background: #ff6b6b;
            color: white;
        }

        .result-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 20px;
        }

        .stress-level {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .stress-level.low {
            color: #51cf66;
        }

        .stress-level.moderate {
            color: #ffd43b;
        }

        .stress-level.high {
            color: #ff6b6b;
        }

        .stress-description {
            font-size: 1.1rem;
            color: var(--text-color);
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .stress-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .factor-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .factor-title {
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .factor-description {
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .recommendations {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .recommendations h3 {
            color: #2d5a2d;
            margin-bottom: 15px;
        }

        .recommendations ul {
            text-align: left;
            color: #2d5a2d;
        }

        .recommendations li {
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .answer-scale {
                flex-direction: column;
                gap: 10px;
            }
            
            .scale-option {
                flex-direction: row;
                min-width: auto;
                width: 100%;
                justify-content: flex-start;
            }
            
            .test-title {
                font-size: 2rem;
            }
            
            .question-text {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="main-header">
            <a href="test_selection.html" class="logo">
                <div class="logo-icon">😰</div>
                <span class="logo-text">스트레스 검사</span>
            </a>
            <button onclick="logout()" class="btn btn-danger btn-sm">로그아웃</button>
        </div>

        <!-- 테스트 헤더 -->
        <div class="test-header">
            <h1 class="test-title">스트레스 검사</h1>
            <p class="test-subtitle">현재 스트레스 수준을 측정하고 관리 방법을 알아보세요</p>
        </div>

        <div class="test-container">
            <!-- 진행률 표시 -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <!-- 질문 섹션 -->
            <div id="questionSection" class="question-container">
                <div class="question-number" id="questionNumber">1</div>
                <div class="question-text" id="questionText">질문이 로드되는 중...</div>
                <div class="answer-scale" id="answerScale">
                    <!-- 답변 옵션들이 여기에 동적으로 생성됩니다 -->
                </div>
                <div class="navigation-buttons">
                    <button class="btn-outline" id="prevButton" onclick="previousQuestion()" style="display: none;">이전</button>
                    <button class="btn" id="nextButton" onclick="nextQuestion()" disabled>다음</button>
                </div>
            </div>

            <!-- 결과 섹션 (숨김) -->
            <div id="resultSection" class="result-container" style="display: none;">
                <h2 class="result-title">검사 결과</h2>
                <div class="stress-level" id="stressLevel">낮음</div>
                <div class="stress-description" id="stressDescription">
                    현재 스트레스 수준이 낮습니다. 좋은 상태를 유지하세요!
                </div>
                <div class="stress-factors" id="stressFactors">
                    <!-- 스트레스 요인들이 여기에 표시됩니다 -->
                </div>
                <div class="recommendations" id="recommendations">
                    <!-- 권장사항들이 여기에 표시됩니다 -->
                </div>
                <div class="navigation-buttons">
                    <button class="btn-outline" onclick="restartTest()">다시 검사하기</button>
                    <button class="btn btn-success" onclick="saveResult()">결과 저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        // 스트레스 검사 데이터
        const stressQuestions = [
            "최근 한 달 동안 잠을 제대로 못 잔 날이 많았나요?",
            "업무나 학업에서 마감일에 쫓기는 느낌이 자주 있나요?",
            "가족이나 친구들과의 관계에서 갈등이 있나요?",
            "건강에 대해 걱정이 많나요?",
            "경제적인 부담을 느끼고 있나요?",
            "새로운 환경이나 변화에 적응하기 어려운가요?",
            "완벽하게 해야 한다는 압박감을 느끼나요?",
            "다른 사람들의 기대에 부응하기 어려운가요?",
            "시간이 부족하다고 느끼는 경우가 많나요?",
            "혼자만의 시간을 갖기 어려운가요?",
            "미래에 대해 불안감을 느끼나요?",
            "의사결정을 내리기 어려운가요?",
            "집중력이 떨어지는 것을 느끼나요?",
            "식욕이 없거나 과식하는 경향이 있나요?",
            "두통이나 소화불량 등의 신체 증상이 있나요?",
            "기분이 우울하거나 불안한가요?",
            "일상적인 일들도 부담스러운가요?",
            "다른 사람들과 어울리기 어려운가요?",
            "취미나 여가 활동에 대한 관심이 줄어들었나요?",
            "전반적으로 삶에 대한 만족도가 낮나요?"
        ];

        // 스트레스 수준별 설명
        const stressLevels = {
            low: {
                level: '낮음',
                description: '현재 스트레스 수준이 낮습니다. 좋은 상태를 유지하고 있습니다.',
                factors: [
                    { title: '긍정적 요인', description: '스트레스 관리가 잘 되고 있음' },
                    { title: '건강 상태', description: '신체적, 정신적으로 안정적' },
                    { title: '대처 능력', description: '스트레스에 효과적으로 대처' }
                ],
                recommendations: [
                    '현재의 좋은 습관을 유지하세요',
                    '규칙적인 운동과 충분한 휴식을 취하세요',
                    '스트레스 관리 기법을 계속 실천하세요'
                ]
            },
            moderate: {
                level: '보통',
                description: '적당한 수준의 스트레스를 경험하고 있습니다. 주의 깊게 관리가 필요합니다.',
                factors: [
                    { title: '주의 요인', description: '일부 스트레스 요인이 존재' },
                    { title: '건강 상태', description: '전반적으로 양호하나 주의 필요' },
                    { title: '대처 능력', description: '스트레스 관리 능력 향상 필요' }
                ],
                recommendations: [
                    '규칙적인 생활 패턴을 유지하세요',
                    '스트레스 해소 활동을 찾아보세요',
                    '충분한 수면과 휴식을 취하세요',
                    '긍정적인 사고방식을 유지하세요'
                ]
            },
            high: {
                level: '높음',
                description: '높은 수준의 스트레스를 경험하고 있습니다. 전문가의 도움이 필요할 수 있습니다.',
                factors: [
                    { title: '위험 요인', description: '다양한 스트레스 요인이 복합적으로 작용' },
                    { title: '건강 상태', description: '신체적, 정신적 건강에 영향 가능' },
                    { title: '대처 능력', description: '스트레스 관리 전략이 필요' }
                ],
                recommendations: [
                    '즉시 스트레스 요인을 줄이세요',
                    '전문가의 상담을 받아보세요',
                    '규칙적인 운동과 명상 등을 실천하세요',
                    '충분한 휴식과 수면을 취하세요',
                    '가족이나 친구의 도움을 요청하세요'
                ]
            }
        };

        // 전역 변수
        let currentQuestion = 0;
        let answers = [];
        let currentUser = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeTest();
        });

        // 테스트 초기화
        async function initializeTest() {
            try {
                // 사용자 정보 확인
                if (window.supabase && window.supabase.isLoggedIn()) {
                    currentUser = await window.supabase.getCurrentUser();
                    if (!currentUser) {
                        redirectToLogin();
                        return;
                    }
                } else {
                    redirectToLogin();
                    return;
                }

                // 첫 번째 질문 표시
                showQuestion(0);
            } catch (error) {
                console.error('테스트 초기화 오류:', error);
                redirectToLogin();
            }
        }

        // 질문 표시
        function showQuestion(questionIndex) {
            const question = stressQuestions[questionIndex];
            
            document.getElementById('questionNumber').textContent = questionIndex + 1;
            document.getElementById('questionText').textContent = question;
            
            // 답변 스케일 생성
            const answerScale = document.getElementById('answerScale');
            answerScale.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const scaleOption = document.createElement('div');
                scaleOption.className = 'scale-option';
                scaleOption.onclick = () => selectAnswer(i);
                
                const scaleNumber = document.createElement('div');
                scaleNumber.className = 'scale-number';
                scaleNumber.textContent = i;
                
                const scaleLabel = document.createElement('div');
                scaleLabel.className = 'scale-label';
                scaleLabel.textContent = getScaleLabel(i);
                
                scaleOption.appendChild(scaleNumber);
                scaleOption.appendChild(scaleLabel);
                answerScale.appendChild(scaleOption);
            }
            
            // 이전 답변이 있으면 선택 상태 복원
            if (answers[questionIndex] !== undefined) {
                const selectedOption = answerScale.children[answers[questionIndex] - 1];
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
            
            // 진행률 업데이트
            updateProgress();
            
            // 네비게이션 버튼 상태 업데이트
            updateNavigationButtons();
        }

        // 스케일 라벨 반환
        function getScaleLabel(value) {
            const labels = ['전혀 그렇지 않다', '그렇지 않다', '보통이다', '그렇다', '매우 그렇다'];
            return labels[value - 1];
        }

        // 답변 선택
        function selectAnswer(answerValue) {
            // 같은 질문의 다른 옵션들 해제
            const scaleOptions = document.querySelectorAll('.scale-option');
            scaleOptions.forEach(option => option.classList.remove('selected'));
            
            // 선택된 옵션 활성화
            event.target.closest('.scale-option').classList.add('selected');
            
            // 답변 저장
            answers[currentQuestion] = answerValue;
            
            // 다음 버튼 활성화
            document.getElementById('nextButton').disabled = false;
        }

        // 다음 질문
        function nextQuestion() {
            if (answers[currentQuestion] === undefined) {
                alert('답변을 선택해주세요.');
                return;
            }
            
            if (currentQuestion < stressQuestions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
            } else {
                // 마지막 질문이면 결과 계산
                calculateResult();
            }
        }

        // 이전 질문
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion(currentQuestion);
            }
        }

        // 진행률 업데이트
        function updateProgress() {
            const progress = ((currentQuestion + 1) / stressQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // 네비게이션 버튼 상태 업데이트
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            prevButton.style.display = currentQuestion > 0 ? 'block' : 'none';
            
            if (currentQuestion === stressQuestions.length - 1) {
                nextButton.textContent = '결과 보기';
            } else {
                nextButton.textContent = '다음';
            }
        }

        // 결과 계산
        function calculateResult() {
            // 총 점수 계산 (1-5점 척도)
            const totalScore = answers.reduce((sum, answer) => sum + answer, 0);
            const averageScore = totalScore / answers.length;
            
            // 스트레스 수준 결정
            let stressLevel;
            if (averageScore <= 2.0) {
                stressLevel = 'low';
            } else if (averageScore <= 3.5) {
                stressLevel = 'moderate';
            } else {
                stressLevel = 'high';
            }
            
            // 결과 표시
            showResult(stressLevel, totalScore, averageScore);
        }

        // 결과 표시
        function showResult(stressLevel, totalScore, averageScore) {
            const levelInfo = stressLevels[stressLevel];
            
            const stressLevelElement = document.getElementById('stressLevel');
            stressLevelElement.textContent = levelInfo.level;
            stressLevelElement.className = `stress-level ${stressLevel}`;
            
            document.getElementById('stressDescription').innerHTML = 
                `${levelInfo.description}<br><small>총점: ${totalScore}점 (평균: ${averageScore.toFixed(1)}점)</small>`;
            
            // 스트레스 요인 표시
            const factorsContainer = document.getElementById('stressFactors');
            factorsContainer.innerHTML = '';
            
            levelInfo.factors.forEach(factor => {
                const factorCard = document.createElement('div');
                factorCard.className = 'factor-card';
                factorCard.innerHTML = `
                    <div class="factor-title">${factor.title}</div>
                    <div class="factor-description">${factor.description}</div>
                `;
                factorsContainer.appendChild(factorCard);
            });
            
            // 권장사항 표시
            const recommendationsContainer = document.getElementById('recommendations');
            recommendationsContainer.innerHTML = `
                <h3>💡 권장사항</h3>
                <ul>
                    ${levelInfo.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
            
            // 질문 섹션 숨기고 결과 섹션 표시
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
        }

        // 결과 저장
        async function saveResult() {
            try {
                if (window.supabase && currentUser) {
                    const stressLevelElement = document.getElementById('stressLevel');
                    const resultData = {
                        level: stressLevelElement.textContent,
                        description: document.getElementById('stressDescription').textContent,
                        totalScore: answers.reduce((sum, answer) => sum + answer, 0),
                        averageScore: (answers.reduce((sum, answer) => sum + answer, 0) / answers.length).toFixed(1)
                    };
                    
                    await window.supabase.createTestResult({
                        user_id: currentUser.id,
                        test_type: 'Stress',
                        result_data: JSON.stringify(resultData),
                        score_data: JSON.stringify(answers)
                    });
                    
                    alert('검사 결과가 저장되었습니다!');
                    window.location.href = 'test_selection.html';
                } else {
                    alert('로그인이 필요합니다.');
                    redirectToLogin();
                }
            } catch (error) {
                console.error('결과 저장 오류:', error);
                alert('결과 저장 중 오류가 발생했습니다.');
            }
        }

        // 테스트 다시 시작
        function restartTest() {
            currentQuestion = 0;
            answers = [];
            document.getElementById('questionSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            showQuestion(0);
        }

        // 로그아웃
        function logout() {
            if (window.supabase) {
                window.supabase.removeToken();
            }
            window.location.href = 'index.html';
        }

        // 로그인 페이지로 리다이렉트
        function redirectToLogin() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
